


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Measurements - jcfrost.FrostSession#sign(byte[],short,short,byte[],short)</title>
        <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Open+Sans">
        <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.3/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.3/highlight.min.js"></script>
    <script>hljs.highlightAll()</script>
    <script src="https://cdn.plot.ly/plotly-2.16.1.min.js"></script>
    <style>


.contents {
    display: flex;
    justify-content: space-between;
}

.modebar-container {
    z-index: 2;
}

.main-svg {
    z-index: 1;
}

.trap {
    position: relative;
}

.trap:hover {
    cursor: pointer;
    font-style: italic;
}

.trap_select {
    background-color: rgba(0, 255, 255, 25%);
    font-style: italic;
}

.trap_err {
    background-color: rgba(255, 0, 0, 25%);
}

.trap_warn {
    background-color: rgba(255, 255, 0, 50%);
}

.trapSwitch {
    bottom: 0;
    position: absolute;
    right: 0;
}

.notes  {
    align-items: center;
    background-color: rgba(248, 248, 248, 0.97);
    display: flex;
    justify-content: space-between;
    padding: 0.5em;
}

.note {
    align-items: center;
    display: flex;
    justify-content: left;
}

.square {
    display: inline-block;
    height: 20px;
    margin-right: 10px;
    width: 20px;
}

.graph {
    align-content: center;
    width: 49%;
}

.graph-sticky {
    top: 0;
    position: -webkit-sticky;
    position: sticky;
}

.code {
    float: left;
    width: 50%;
}

pre {
    /* override the default pre margin in Firefox and Chrome */
    margin-bottom: 0;
}

#codeWithTraps, #codeWithoutTraps {
    flex: 1;
    margin-left: -100px;
    overflow-x: auto;
}

#codeWithTraps, #graphHelp {
    display: none;
}

.codeHeader {
    position: relative;
    margin-bottom: 20px;
    word-wrap: anywhere;
}

.codeContainer {
    display: flex;
    justify-content: flex-start;
}

.codeWrapper {
    display: inline-block;
    min-width: 100%;
}

.center {
    text-align: center;
}
    </style>
</head>
<body>
    <h1>jcfrost.FrostSession#sign(byte[],short,short,byte[],short)</h1>
    <h3 id="graphName" class="center"></h3>
    <div class="contents">
        <div class="code">
            <div class="codeHeader">
                <div>
                    <b>Mode:</b> time<br>
                    <b>Card ATR:</b>                         <a href="https://smartcard-atr.apdu.fr/parse?ATR=3BD518FF8191FE1FC38073C821100A" target="_blank">3BD518FF8191FE1FC38073C821100A</a>
<br>
                        <b>Number of rounds:</b> 100<br>
                    <b>APDU header:</b> 00040400<br>
                        <b>Input regex:</b>
66726f7374<br>
                        <b>Input division:</b> none<br>
                    <b>Elapsed time:</b> 0 days 00:28:38.865<br>
                    <b>Source measurements:</b> <a href="measurements.csv" target="_blank">measurements.csv</a>
                </div>
                <div class="trapSwitch">
                    <input type="checkbox" id="trapSwitch" autocomplete="off"/>
                    <label for="trapSwitch">Show explicit traps</label>
                </div>
            </div>
            <div class="codeContainer">
<div id="heatmap"></div>                <div id="codeWithTraps">
                    <div class="codeWrapper">
                        <pre><code class="language-java">public void sign(byte[] msg, short msgOffset, short msgLength, byte[] output, short outputOffset) {
<div class="TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_1 trap">    <span class="trap_contents">PM.check(PMC.TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_1);</span>
</div>    computeBindingFactors(msg, msgOffset, msgLength);
<div class="TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_2 trap">    <span class="trap_contents">PM.check(PMC.TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_2);</span>
</div>    computeGroupCommitment();
<div class="TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_3 trap">    <span class="trap_contents">PM.check(PMC.TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_3);</span>
</div>    computeLambdaOptimized();
<div class="TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_4 trap">    <span class="trap_contents">PM.check(PMC.TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_4);</span>
</div>    computeChallenge(msg, msgOffset, msgLength);
<div class="TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_5 trap">    <span class="trap_contents">PM.check(PMC.TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_5);</span>
</div>    computeSignatureShare(output, outputOffset);
<div class="TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_6 trap">    <span class="trap_contents">PM.check(PMC.TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_6);</span>
</div>}
</code></pre>
                    </div>
                </div>
                <div id="codeWithoutTraps">
                    <div class="codeWrapper">
                                                                        <pre><code class="language-java"><div class="TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_1 trap"><span class="trap_contents">public void sign(byte[] msg, short msgOffset, short msgLength, byte[] output, short outputOffset) {</span>
</div><div class="TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_2 trap">    <span class="trap_contents">computeBindingFactors(msg, msgOffset, msgLength);</span>
</div><div class="TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_3 trap">    <span class="trap_contents">computeGroupCommitment();</span>
</div><div class="TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_4 trap">    <span class="trap_contents">computeLambdaOptimized();</span>
</div><div class="TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_5 trap">    <span class="trap_contents">computeChallenge(msg, msgOffset, msgLength);</span>
</div><div class="TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_6 trap">    <span class="trap_contents">computeSignatureShare(output, outputOffset);</span>
</div>}
</code></pre>
                    </div>
                </div>
            </div>
            <div>
                <h3 class="center">Colour explanation</h3>
                <div class="notes">
                    <div class="note">
                        <div class="square trap_select"></div>
                        Currently selected trap
                    </div>
                    <div class="note">
                        <div class="square trap_warn"></div>
                        Trap was never reached
                    </div>
                    <div class="note">
                        <div class="square trap_err"></div>
                        Trap was reached only sometimes
                    </div>
                </div>
            </div>
        </div>
        <div class="graph">
            <div class="graph-sticky">
                <div id="graphHelp" class="center">
                    <p>Click on a graph item to get a list of corresponding inputs.</p>
                </div>
                <div id="plotly"></div>
            </div>
        </div>
    </div>
    <script type="application/javascript">


const heatmapX = [
    'Avg μs',
];
const heatmapData  = {
    colorscale: 'RdBu'
};


/*
 * MACROS
 */


/*
 * CONSTANTS
 */

const trapPrefix = 'TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_';

const inputs = ['66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374', '66726f7374'];
const measurements = {
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_1: [7437, 7480, 6768, 7539, 7110, 7461, 6819, 6789, 7470, 7245, 7408, 7452, 7431, 7568, 6698, 7139, 7231, 7422, 7314, 7060, 6795, 7293, 6691, 7138, 7577, 6737, 6668, 7289, 6818, 7248, 6986, 6699, 6876, 7279, 7215, 7220, 7272, 7243, 7283, 7298, 7332, 6985, 6940, 7387, 7461, 6946, 7294, 7221, 6975, 7115, 7400, 7166, 7199, 6664, 7017, 7308, 7165, 7246, 6906, 7229, 6882, 7196, 7118, 7302, 7367, 7446, 7410, 7448, 7247, 7454, 7200, 7251, 7531, 7440, 7312, 6889, 7164, 6794, 7178, 7200, 7147, 7413, 7216, 6798, 7279, 7322, 7337, 7345, 7002, 7171, 7343, 7193, 7055, 6935, 7118, 7046, 7207, 7049, 6844, 7252],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_2: [2276250, 2295656, 2300744, 2290071, 2285437, 2298141, 2283783, 2274888, 2277325, 2297952, 2302914, 2271397, 2296574, 2279308, 2286942, 2273576, 2294985, 2290781, 2298971, 2296987, 2299519, 2299185, 2288493, 2299615, 2288364, 2291488, 2297615, 2278054, 2290334, 2274818, 2289469, 2295147, 2276244, 2290043, 2281187, 2292417, 2300818, 2289552, 2297637, 2276304, 2295952, 2290073, 2299306, 2290499, 2306073, 2304526, 2274299, 2288434, 2300073, 2290555, 2271344, 2283778, 2290503, 2288017, 2281127, 2303352, 2297026, 2289730, 2275619, 2284599, 2295122, 2287588, 2301082, 2284811, 2301927, 2297682, 2298441, 2291488, 2294256, 2286027, 2289362, 2288291, 2302432, 2299962, 2277850, 2271879, 2301780, 2297010, 2285203, 2289973, 2287931, 2293520, 2296707, 2297981, 2299254, 2279953, 2285501, 2296398, 2277419, 2276507, 2297724, 2282169, 2288499, 2291817, 2295299, 2305292, 2277171, 2288729, 2283841, 2281923],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_3: [832509, 821178, 819918, 826196, 820708, 820793, 820657, 820099, 822040, 819558, 819533, 821315, 821214, 819304, 820170, 822173, 819518, 819560, 820627, 820841, 821923, 819272, 820553, 820833, 821511, 819974, 819258, 829581, 820925, 820719, 820852, 820383, 818147, 819281, 821419, 820956, 820038, 821040, 823353, 829024, 820584, 821001, 820353, 820732, 821523, 820159, 820192, 820421, 820451, 821317, 826858, 818867, 819905, 817288, 821886, 820658, 818915, 818685, 820322, 819685, 820713, 819970, 818248, 819863, 820120, 821790, 819358, 819114, 820645, 821807, 819722, 817547, 820363, 819936, 822810, 819188, 821448, 819526, 820664, 820097, 818293, 821060, 820056, 820023, 821093, 819738, 819476, 819226, 820331, 821734, 819576, 813462, 819974, 820441, 818907, 818804, 821041, 819848, 819418, 818600],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_4: [174088, 149357, 160535, 159714, 151151, 163441, 163770, 154731, 160847, 151719, 150760, 158915, 153294, 152707, 150987, 157601, 152886, 151677, 162767, 162908, 149723, 156055, 161837, 150112, 164769, 165178, 152540, 158210, 160167, 162794, 161415, 162679, 152284, 151665, 147304, 154565, 154898, 160215, 147984, 151601, 150120, 158121, 163685, 162700, 153318, 154966, 167370, 150876, 156430, 157292, 162898, 152361, 153311, 151805, 152920, 150215, 154410, 152530, 152945, 152107, 162207, 151569, 165322, 155061, 155407, 148999, 156896, 151886, 159043, 157565, 164166, 161193, 153064, 151911, 160854, 153319, 151832, 164394, 157537, 150225, 164876, 152586, 163795, 151648, 158238, 155127, 165199, 154989, 154575, 148498, 151397, 156709, 160296, 150016, 156395, 163517, 161280, 151630, 163110, 164092],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_5: [175005, 195515, 194242, 198158, 196211, 200201, 201502, 203835, 202978, 196659, 197248, 194486, 201418, 194817, 196437, 199452, 194658, 195994, 202366, 199502, 195858, 200230, 202684, 197024, 197982, 198752, 193547, 197336, 194667, 200302, 204463, 203488, 195463, 195614, 198734, 204337, 202425, 196006, 196050, 192409, 197347, 199782, 198716, 193571, 199949, 200707, 197002, 187932, 207561, 198341, 210523, 196286, 202097, 193905, 202542, 196996, 202043, 193445, 202715, 194572, 204492, 195665, 199245, 200315, 199830, 198344, 198407, 196510, 195581, 188461, 201065, 192925, 205508, 195005, 203453, 193715, 202315, 202822, 196830, 197956, 196342, 202178, 197775, 192956, 194640, 202526, 187920, 201874, 198939, 198374, 193051, 194050, 194694, 198786, 189588, 201794, 204666, 197071, 199717, 199570],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_6: [404323, 442197, 427786, 443417, 418535, 448794, 412252, 428508, 436544, 438619, 418192, 426685, 418575, 446232, 427407, 422909, 446110, 435141, 412528, 439399, 414927, 440245, 429994, 401194, 442787, 439873, 409661, 417201, 417082, 421223, 427624, 447538, 437243, 443107, 430231, 437462, 420894, 434811, 413311, 420587, 416724, 423948, 424375, 426403, 420058, 428665, 412145, 398273, 428601, 413549, 392332, 437711, 412548, 444572, 409525, 451486, 419241, 427640, 445323, 435940, 445033, 453538, 423423, 410425, 420158, 417203, 431692, 425684, 416069, 460095, 419307, 446807, 443974, 427464, 426974, 447466, 400090, 440468, 423789, 442470, 459728, 399418, 413252, 436320, 441188, 439884, 440297, 421350, 421833, 424248, 453481, 427924, 443559, 431356, 458069, 421372, 417233, 433028, 447784, 450302]
};

const heatmapValues = {
    x: heatmapX,
    y: [...Array(13 + 1).keys()].splice(1).reverse(),
    z: [[null], [429139.62], [null], [198222.6], [null], [156429.95], [null], [820377.18], [null], [2289996.71], [null], [7173.23], [null]]
};

const heatmapValuesFiltered = {
    x: heatmapValues.x,
    y: undefined,
    z: heatmapValues.z.filter((e, i, z) => i === 0 || z[i][0] !== null || z[i - 1][0] === null)
};
heatmapValuesFiltered.y = heatmapValues.y.slice(13 - heatmapValuesFiltered.z.length, 13);

const histogramCommon = {
    bingroup: '1',
    type: 'histogram',
    xaxis: 'x2',
    yaxis: 'y1',
    showlegend: true,
    hovertemplate: 'Trace: %{meta[0]}<br>Bin: %{x}<br>Count: %{y}<extra></extra>'
};

const configCommon = {
    displaylogo: false,
    responsive: true,
    toImageButtonOptions: {
        format: 'svg',
        scale: 2
    }
};

/*
 * FUNCTIONS
 */

// this is not very nice but Google didn't help much, nor I'm a JS developer ¯\_(ツ)_/¯
let heatmapHeight;
window.addEventListener('load', _ => {
    heatmapHeight = document.querySelector('#codeWithoutTraps code').clientHeight + 6;
    const maxLineStringSize = 2 * heatmapValues.y[0].toString().length;

    // Heatmap
    Plotly.newPlot('heatmap', [{
        ...heatmapValuesFiltered,
        hovertemplate: 'Line: %{y}<br>%{z} μs<extra></extra>',
        showlegend: false,
        showscale: false,
        type: 'heatmap',
        xgap: 4,
        ...heatmapData
    }], {
        paper_bgcolor: 'rgba(0, 0, 0, 0)',
        margin: {
            l: 18 + maxLineStringSize,
            r: 110,
            b: 0,
            t: 18,
            pad: 4
        },
        height: heatmapHeight,
        width: 112 + 45 * heatmapValues.x.length + maxLineStringSize,
        xaxis: {
            side: 'top',
            fixedrange: true,
            ticks: '',
            showgrid: false,
            zeroline: false
        },
        yaxis: {
            fixedrange: true,
            ticks: '',
            title: '',
            type: 'category',
            showgrid: false,
            zeroline: false
        }
    }, {
        displayModeBar: false
    });

    // Heatmap click event handler
    const heatmapDiv = document.getElementById('heatmap');
    heatmapDiv.on('plotly_click', function (data) {
        const graph = data.points[0];
        // check for a valid value
        if (graph.z === null)
            return;

        // compute the correct trap index
        const z = graph.data.z;

        let trapIdx = 0;
        for (let i = z.length - 1; i >= z.length - graph.y; i--) {
            if (z[i][0] !== null)
                trapIdx++;
        }

        // select the given trap
        const trapDiv = document.querySelector('.' + trapPrefix + trapIdx);
        const event = new MouseEvent('click');
        trapDiv.dispatchEvent(event);
    });
});

/**
 * Shows or hides explicit performance traps.
 *
 * @param {Event} event change event
 */
function toggleTraps(event) {
    const divWith = document.getElementById('codeWithTraps');
    const divWithout = document.getElementById('codeWithoutTraps');

    if (event.currentTarget.checked) {
        divWith.style.display = 'initial';
        divWithout.style.display = 'none';

        const codeWith = divWith.querySelector('code');
        Plotly.update('heatmap', {
            x: [heatmapValues.x],
            y: [heatmapValues.y],
            z: [heatmapValues.z]
        }, {
            'yaxis.type': 'category',
            height: codeWith.clientHeight + 6
        });
        return;
    }

    divWith.style.display = 'none';
    divWithout.style.display = 'initial';

    Plotly.update('heatmap', {
        x: [heatmapValuesFiltered.x],
        y: [heatmapValuesFiltered.y],
        z: [heatmapValuesFiltered.z]
    }, {
        'yaxis.type': 'category',
        height: heatmapHeight
    });
}

/**
 * Highlights and selects the given trap.
 *
 * @param {String} trapName
 */
function selectTraps(trapName) {
    // update highlight of the selected trap
    document.querySelectorAll('.trap .trap_select').forEach(t => t.classList.remove('trap_select'));
    document.querySelectorAll('.' + trapName + ' .trap_contents').forEach(t => t.classList.add('trap_select'));
}

/*
 * CONSTANTS
 */

const filteredMeasurements = {
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_1: [7437, 7480, 6768, 7539, 7110, 7461, 6819, 6789, 7470, 7245, 7408, 7452, 7431, 7568, 6698, 7139, 7231, 7422, 7314, 7060, 6795, 7293, 6691, 7138, 7577, 6737, 6668, 7289, 6818, 7248, 6986, 6699, 6876, 7279, 7215, 7220, 7272, 7243, 7283, 7298, 7332, 6985, 6940, 7387, 7461, 6946, 7294, 7221, 6975, 7115, 7400, 7166, 7199, 6664, 7017, 7308, 7165, 7246, 6906, 7229, 6882, 7196, 7118, 7302, 7367, 7446, 7410, 7448, 7247, 7454, 7200, 7251, 7531, 7440, 7312, 6889, 7164, 6794, 7178, 7200, 7147, 7413, 7216, 6798, 7279, 7322, 7337, 7345, 7002, 7171, 7343, 7193, 7055, 6935, 7118, 7046, 7207, 7049, 6844, 7252],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_2: [2276250, 2295656, 2300744, 2290071, 2285437, 2298141, 2283783, 2274888, 2277325, 2297952, 2302914, 2271397, 2296574, 2279308, 2286942, 2273576, 2294985, 2290781, 2298971, 2296987, 2299519, 2299185, 2288493, 2299615, 2288364, 2291488, 2297615, 2278054, 2290334, 2274818, 2289469, 2295147, 2276244, 2290043, 2281187, 2292417, 2300818, 2289552, 2297637, 2276304, 2295952, 2290073, 2299306, 2290499, 2306073, 2304526, 2274299, 2288434, 2300073, 2290555, 2271344, 2283778, 2290503, 2288017, 2281127, 2303352, 2297026, 2289730, 2275619, 2284599, 2295122, 2287588, 2301082, 2284811, 2301927, 2297682, 2298441, 2291488, 2294256, 2286027, 2289362, 2288291, 2302432, 2299962, 2277850, 2271879, 2301780, 2297010, 2285203, 2289973, 2287931, 2293520, 2296707, 2297981, 2299254, 2279953, 2285501, 2296398, 2277419, 2276507, 2297724, 2282169, 2288499, 2291817, 2295299, 2305292, 2277171, 2288729, 2283841, 2281923],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_3: [null, 821178, 819918, 826196, 820708, 820793, 820657, 820099, 822040, 819558, 819533, 821315, 821214, 819304, 820170, 822173, 819518, 819560, 820627, 820841, 821923, 819272, 820553, 820833, 821511, 819974, 819258, null, 820925, 820719, 820852, 820383, 818147, 819281, 821419, 820956, 820038, 821040, 823353, null, 820584, 821001, 820353, 820732, 821523, 820159, 820192, 820421, 820451, 821317, 826858, 818867, 819905, 817288, 821886, 820658, 818915, 818685, 820322, 819685, 820713, 819970, 818248, 819863, 820120, 821790, 819358, 819114, 820645, 821807, 819722, 817547, 820363, 819936, 822810, 819188, 821448, 819526, 820664, 820097, 818293, 821060, 820056, 820023, 821093, 819738, 819476, 819226, 820331, 821734, 819576, null, 819974, 820441, 818907, 818804, 821041, 819848, 819418, 818600],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_4: [null, 149357, 160535, 159714, 151151, 163441, 163770, 154731, 160847, 151719, 150760, 158915, 153294, 152707, 150987, 157601, 152886, 151677, 162767, 162908, 149723, 156055, 161837, 150112, 164769, 165178, 152540, 158210, 160167, 162794, 161415, 162679, 152284, 151665, 147304, 154565, 154898, 160215, 147984, 151601, 150120, 158121, 163685, 162700, 153318, 154966, 167370, 150876, 156430, 157292, 162898, 152361, 153311, 151805, 152920, 150215, 154410, 152530, 152945, 152107, 162207, 151569, 165322, 155061, 155407, 148999, 156896, 151886, 159043, 157565, 164166, 161193, 153064, 151911, 160854, 153319, 151832, 164394, 157537, 150225, 164876, 152586, 163795, 151648, 158238, 155127, 165199, 154989, 154575, 148498, 151397, 156709, 160296, 150016, 156395, 163517, 161280, 151630, 163110, 164092],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_5: [null, 195515, 194242, 198158, 196211, 200201, 201502, 203835, 202978, 196659, 197248, 194486, 201418, 194817, 196437, 199452, 194658, 195994, 202366, 199502, 195858, 200230, 202684, 197024, 197982, 198752, 193547, 197336, 194667, 200302, 204463, 203488, 195463, 195614, 198734, 204337, 202425, 196006, 196050, 192409, 197347, 199782, 198716, 193571, 199949, 200707, 197002, 187932, 207561, 198341, 210523, 196286, 202097, 193905, 202542, 196996, 202043, 193445, 202715, 194572, 204492, 195665, 199245, 200315, 199830, 198344, 198407, 196510, 195581, 188461, 201065, 192925, 205508, 195005, 203453, 193715, 202315, 202822, 196830, 197956, 196342, 202178, 197775, 192956, 194640, 202526, 187920, 201874, 198939, 198374, 193051, 194050, 194694, 198786, 189588, 201794, 204666, 197071, 199717, 199570],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_6: [404323, 442197, 427786, 443417, 418535, 448794, 412252, 428508, 436544, 438619, 418192, 426685, 418575, 446232, 427407, 422909, 446110, 435141, 412528, 439399, 414927, 440245, 429994, 401194, 442787, 439873, 409661, 417201, 417082, 421223, 427624, 447538, 437243, 443107, 430231, 437462, 420894, 434811, 413311, 420587, 416724, 423948, 424375, 426403, 420058, 428665, 412145, 398273, 428601, 413549, 392332, 437711, 412548, 444572, 409525, 451486, 419241, 427640, 445323, 435940, 445033, 453538, 423423, 410425, 420158, 417203, 431692, 425684, 416069, 460095, 419307, 446807, 443974, 427464, 426974, 447466, 400090, 440468, 423789, 442470, 459728, 399418, 413252, 436320, 441188, 439884, 440297, 421350, 421833, 424248, 453481, 427924, 443559, 431356, 458069, 421372, 417233, 433028, 447784, 450302]
};

const movingAverages = {
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_1: [7437.0, 7458.5, 7228.333333333333, 7306.0, 7266.8, 7299.166666666667, 7230.571428571428, 7175.375, 7208.111111111111, 7211.8, 7208.9, 7206.1, 7272.4, 7275.3, 7234.1, 7201.9, 7243.1, 7306.4, 7290.8, 7272.3, 7211.0, 7195.1, 7121.1, 7078.1, 7166.0, 7125.8, 7069.5, 7056.2, 7006.6, 7025.4, 7044.5, 6985.1, 7003.6, 7017.7, 6981.5, 7029.8, 7090.2, 7085.6, 7132.1, 7137.1, 7171.7, 7200.3, 7206.7, 7217.5, 7242.1, 7214.7, 7216.9, 7214.7, 7183.9, 7165.6, 7172.4, 7190.5, 7216.4, 7144.1, 7099.7, 7135.9, 7123.0, 7125.5, 7118.6, 7130.0, 7078.2, 7081.2, 7073.1, 7136.9, 7171.9, 7185.7, 7210.2, 7230.4, 7264.5, 7287.0, 7318.8, 7324.3, 7365.6, 7379.4, 7373.9, 7318.2, 7293.6, 7228.2, 7221.3, 7195.9, 7190.6, 7206.8, 7175.3, 7111.1, 7107.8, 7151.1, 7168.4, 7223.5, 7205.9, 7203.0, 7222.6, 7200.6, 7184.5, 7198.2, 7182.1, 7154.5, 7141.5, 7111.9, 7096.1, 7104.2],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_2: [2276250.0, 2285953.0, 2290883.3333333335, 2290680.25, 2289631.6, 2291049.8333333335, 2290011.714285714, 2288121.25, 2286921.6666666665, 2288024.7, 2290691.1, 2288265.2, 2287848.2, 2286771.9, 2286922.4, 2284465.9, 2285586.1, 2287175.4, 2289340.0, 2289243.5, 2288904.0, 2291682.8, 2290874.7, 2292905.4, 2293047.6, 2294838.8, 2295101.8, 2293829.1, 2292965.4, 2290748.5, 2289743.5, 2289339.7, 2288114.8, 2287157.6, 2286439.9, 2286532.8, 2286853.1, 2288002.9, 2288733.2, 2288881.8, 2289530.1, 2289022.7, 2291328.9, 2291374.5, 2293863.1, 2295074.0, 2292422.1, 2292310.3, 2292553.9, 2293979.0, 2291518.2, 2290888.7, 2290008.4, 2289760.2, 2287265.6, 2287148.2, 2289420.9, 2289550.5, 2287105.1, 2286509.5, 2288887.3, 2289268.3, 2290326.2, 2290005.6, 2292085.6, 2291518.6, 2291660.1, 2291835.9, 2293699.6, 2293842.4, 2293266.4, 2293336.7, 2293471.7, 2294986.8, 2292579.1, 2289998.8, 2290332.7, 2290884.9, 2289979.6, 2290374.2, 2290231.1, 2290754.0, 2290181.5, 2289983.4, 2292123.8, 2292931.2, 2291303.3, 2291242.1, 2290463.7, 2289117.1, 2290096.4, 2288961.3, 2288140.5, 2287524.1, 2287128.6, 2289662.5, 2288829.5, 2288062.6, 2288704.8, 2289246.4],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_3: [832509.0, 826843.5, 824535.0, 824950.25, 824101.8, 823550.3333333334, 823137.0, 822757.25, 822677.5555555555, 822365.6, 821068.0, 821081.7, 821211.3, 820522.1, 820468.3, 820606.3, 820492.4, 820438.5, 820297.2, 820425.5, 820664.5, 820460.2, 820394.1, 820547.0, 820681.1, 820461.2, 820435.2, 821437.3, 821467.1, 821454.9, 821347.8, 821458.9, 821218.3, 821063.1, 821053.9, 821152.1, 821230.1, 820376.0, 820618.8, 821449.3, 821422.5, 821484.3, 821704.9, 821850.0, 821860.4, 821780.7, 821796.1, 821734.2, 821444.0, 820673.3, 821300.7, 821087.3, 821042.5, 820698.1, 820734.4, 820784.3, 820656.6, 820483.0, 820470.1, 820306.9, 819692.4, 819802.7, 819637.0, 819894.5, 819717.9, 819831.1, 819875.4, 819918.3, 819950.6, 820162.8, 820063.7, 819821.4, 820032.9, 820040.2, 820309.2, 820049.0, 820258.0, 820299.2, 820301.1, 820130.1, 819987.2, 820338.5, 820307.8, 820316.5, 820144.8, 820199.8, 820002.6, 819972.6, 819939.3, 820103.0, 820231.3, 819471.5, 819463.3, 819505.1, 819286.5, 819193.1, 819349.6, 819411.8, 819320.5, 819007.1],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_4: [174088.0, 161722.5, 161326.66666666666, 160923.5, 158969.0, 159714.33333333334, 160293.7142857143, 159598.375, 159737.11111111112, 158935.3, 156602.5, 157558.3, 156834.2, 156133.5, 156117.1, 155533.1, 154444.7, 154139.3, 154331.3, 155450.2, 155346.5, 155060.5, 155914.8, 155655.3, 157033.5, 157791.2, 157756.6, 158409.9, 158149.9, 158138.5, 159307.7, 159970.1, 159014.8, 159170.1, 157423.6, 156362.3, 156598.1, 156798.6, 155580.3, 154461.0, 153331.5, 152875.7, 154015.8, 155119.3, 155720.7, 155760.8, 157008.0, 156074.1, 156918.7, 157487.8, 158765.6, 158189.6, 157152.2, 156062.7, 156022.9, 155547.8, 154251.8, 154417.2, 154068.7, 153550.2, 153481.1, 153401.9, 154603.0, 154928.6, 155177.3, 155055.7, 155304.3, 155239.9, 155849.7, 156395.5, 156591.4, 157553.8, 156328.0, 156013.0, 156557.7, 156989.7, 156483.3, 157734.1, 157583.5, 156849.5, 156920.5, 156059.8, 157132.9, 157106.6, 156845.0, 157025.8, 158362.5, 157422.0, 157125.8, 156953.1, 155605.2, 156017.5, 155667.6, 155504.4, 155320.1, 156159.1, 155767.2, 155431.3, 156284.8, 157844.2],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_5: [175005.0, 185260.0, 188254.0, 190730.0, 191826.2, 193222.0, 194404.85714285713, 195583.625, 196405.22222222222, 196430.6, 198654.9, 198552.0, 199269.6, 198935.5, 198958.1, 198883.2, 198198.8, 197414.7, 197353.5, 197637.8, 197498.8, 198073.2, 198199.8, 198420.5, 198575.0, 198505.0, 198393.9, 198528.1, 197758.2, 197838.2, 198698.7, 199024.5, 198302.4, 198161.4, 198236.6, 198795.1, 199682.9, 199549.9, 199688.2, 198898.9, 198187.3, 197816.7, 198142.0, 197937.7, 198059.2, 197696.2, 197153.9, 196346.5, 197497.6, 198090.8, 199408.4, 199058.8, 199396.9, 199430.3, 199689.6, 199318.5, 199822.6, 200373.9, 199889.3, 199512.4, 198909.3, 198847.2, 198562.0, 199203.0, 198931.8, 199066.6, 198703.0, 199009.5, 198296.1, 197685.0, 197342.3, 197068.3, 197694.6, 197163.6, 197525.9, 197063.0, 197453.8, 198085.0, 198209.9, 199159.4, 198687.1, 199612.4, 198839.1, 198634.2, 197752.9, 198634.0, 197194.5, 197099.7, 197310.6, 197352.4, 197023.3, 196210.5, 195902.4, 196485.4, 195980.2, 195907.0, 197581.6, 197101.3, 197179.1, 197298.7],
    TRAP_jcfrost_FrostSession_hash_sign_argb_byte_arr__short__short__byte_arr__short_arge_6: [404323.0, 423260.0, 424768.6666666667, 429430.75, 427251.6, 430842.0, 428186.28571428574, 428226.5, 429150.6666666667, 430097.5, 431484.4, 429933.2, 429012.1, 429293.6, 430180.8, 427592.3, 430978.1, 431641.4, 429239.8, 429317.8, 428991.3, 430347.3, 431489.2, 426985.4, 428523.4, 430219.8, 426574.9, 424780.9, 425236.3, 423418.7, 424688.4, 425417.7, 426142.6, 430333.9, 429078.3, 428837.2, 429960.5, 431721.5, 431344.4, 431280.8, 430190.8, 427831.8, 426545.0, 424874.6, 423857.3, 422977.6, 422102.7, 418448.9, 419977.9, 419274.1, 416834.9, 418211.2, 417028.5, 418845.4, 417792.1, 420074.2, 420783.8, 423720.5, 425392.7, 427631.8, 432901.9, 434484.6, 435572.1, 432157.4, 433220.7, 429792.4, 431037.5, 430841.9, 427916.5, 430332.0, 427759.4, 427086.3, 429141.4, 430845.3, 431526.9, 434553.2, 431393.0, 432871.4, 433643.4, 431880.9, 435923.0, 431184.1, 428111.9, 428997.5, 430418.9, 429660.7, 433681.4, 431769.6, 431574.0, 429751.8, 429127.1, 431977.7, 435008.4, 434512.0, 436200.1, 434348.9, 432042.5, 433210.3, 435805.4, 438410.8]
};

const scatterCommon = {
    type: 'scatter',
    xaxis: 'x3',
    yaxis: 'y2',
    name: 'elapsed time',
    showlegend: true,
    marker: {
        color: 'rgb(225, 148, 22)'
    },
    hovertemplate: 'Trace: elapsed time<br>Round: %{x}<br>Time: %{y} μs<extra></extra>'
};

const layoutCommon = {
    bargap: 0.2,
    barmode: 'overlay',
    height: 700,
    margin: {
        l: 60,
        r: 40,
        b: 40,
        t: 40,
        pad: 5
    },
    xaxis1: {
        anchor: 'y1',
        title: 'Unreachable'
    },
    xaxis2: {
        anchor: 'y1',
        // dtick: 1,
        tickformat: ',d',
        title: 'Time in μs'
    },
    xaxis3: {
        anchor: 'y2',
        domain: [0, 1],
        tickformat: ',d',
        title: 'Round'
    },
    yaxis1: {
        anchor: 'x1',
        domain: [0.55, 1],
        title: 'Frequency'
        // type: 'log',
    },
    yaxis2: {
        anchor: 'x3',
        domain: [0, 0.43],
        title: 'Time in μs'
    }
};

/*
 * FUNCTIONS
 */

// set default heading
document.getElementById('graphName').innerText = 'Select a line to view its histogram.';

/**
 * Redraw graph event handler
 *
 * @param {Event} evt mouse click event
 */
function redrawGraph(evt) {
    // enable graph help
    document.getElementById('graphHelp').style.display = 'initial';

    // attribute with trap name is always the first
    const trapName = evt.currentTarget.classList[0];

    // update highlight of the selected trap
    selectTraps(trapName);

    // update trap title
    document.getElementById('graphName').textContent = trapName;

    const filteredVals = filteredMeasurements[trapName];
    const movingAverage = movingAverages[trapName];
    const vals = measurements[trapName];

    const traces = [];

    const hasTime = vals.some(e => e !== null);
    if (hasTime) {
        // Histograms
        traces.push({
            ...histogramCommon,
            x: filteredVals,
            name: 'measurements',
            meta: ['measurements'],
            marker: {
                color: 'rgb(49, 130, 189)',
                opacity: 0.75
            }
        });

        traces.push({
            ...histogramCommon,
            x: vals.map((e, i) => filteredVals[i] !== null ? null : e),
            name: 'outliers',
            meta: ['outliers'],
            visible: 'legendonly',
            marker: {
                color: 'rgb(255, 136, 0)',
                opacity: 0.75
            }
        });

        // Line graph

        // make dots only on line endings
        const dot_x = [], dot_y = [];
        for (let i = 0; i < vals.length; i++) {
            // no value
            if (vals[i] === null)
                continue;

            // both neighbouring values are defined or only one is defined on border values
            if (vals.length > 1 &&
                (i === 0 || vals[i - 1] !== null) && (i === vals.length - 1 || vals[i + 1] != null))
                continue;

            dot_x.push(i + 1);
            dot_y.push(vals[i]);
        }

        traces.push({
            ...scatterCommon,
            x: dot_x,
            y: dot_y,
            mode: 'markers',
            showlegend: false
        }, {
            ...scatterCommon,
            x: [...Array(vals.length + 1).keys()].splice(1),
            y: vals,
            mode: 'lines'
        }, {
            ...scatterCommon,
            x: [...Array(vals.length + 1).keys()].splice(1),
            y: movingAverage,
            name: 'moving average',
            marker: {
                color: 'rgb(166, 56, 64)'
            },
            hovertemplate: 'Trace: moving average<br>Round: %{x}<br>Average time: %{y} μs<extra></extra>'
        });
    }

    // bar graph visualising number of unreachable rounds
    const hasUnreach = vals.includes(null);
    if (hasUnreach) {
        const y = vals.filter(e => e === null).length;
        traces.push({
            x: [''],
            y: [y],
            type: 'bar',
            xaxis: 'x1',
            yaxis: 'y1',
            name: 'unreachable',
            showlegend: false,
            marker: {
                color: 'rgb(255, 0, 0)',
                opacity: 0.65
            },
            hovertemplate: 'Unreachable<br>Count: %{y} (%{y}/' + vals.length + ')<extra></extra>'
        });
    }

    // WARNING: Layout and config must be passed directly!  Otherwise, sometimes the graph may fail to load.
    Plotly.react('plotly', traces, {
        ...layoutCommon,
        xaxis1: {
            ...layoutCommon.xaxis1,
            domain: [0, hasTime ? 0.45 : 1]
        },
        xaxis2: {
            ...layoutCommon.xaxis2,
            domain: [hasUnreach ? 0.55 : 0, 1]
        }
    }, {...configCommon});

    // set click event handler
    const plotlyDiv = document.getElementById('plotly');

    // get bin half of the bin size
    // Unfortunately, the xbins.size key is stored only in the first histogram trace and not in the rest, so we have
    // to obtain this value in advance.
    const binSizeHalf = plotlyDiv._fullData[0].xbins.size / 2;

    // replace the event handler
    plotlyDiv.removeAllListeners('plotly_click');
    plotlyDiv.on('plotly_click', function (data) {
        const graph = data.points[0];
        let msg = '', selectedInputs;

        switch (graph.data.type) {
            // line graph
            case 'scatter':
                selectedInputs = [inputs[graph.x - 1]];
                msg = 'Round: ' + graph.x + '\n';
                break;
            case 'histogram':
                selectedInputs = graph.pointIndices.map(
                    e => inputs[ e]);

                msg += 'Bin: ' + Math.ceil(graph.x - binSizeHalf) + ' to ' + Math.floor(graph.x + binSizeHalf) + '\n';
                break;
            case 'bar':
                selectedInputs = vals.reduce((res, e, i) => {
                    if (e === null)
                        res.push(inputs[i]);
                    return res;
                }, []);
                console.assert(selectedInputs.length === graph.y);

                msg = 'Unreachable\n';
                break;
            default:
                return;
        }

        msg += 'Inputs:\n';

        const sortedInputs = Array.from(new Set(selectedInputs)).sort();
        sortedInputs.forEach(e => msg += '00040400' + e + '\n');

        alert(msg);
    });
}

// Set-up event listeners
window.addEventListener('load', _ => {
    document.getElementById('trapSwitch').addEventListener('change', toggleTraps);
    document.querySelectorAll('.trap').forEach(elem => elem.addEventListener('click', evt => redrawGraph(evt)));
});
    </script>
</body>
</html>
